

<style>

.dv-content {
    padding: 10px;
}

.dv-content-title {
    font-size: 22px;
    font-weight: bold;
    color: #333;
}

.dv-content-box{
    background-color: white;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
}

.dv-content .dv-content-box.box1{
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: end;
    gap: 10px;
}

.dv-content .dv-content-box.box1 .form-group{
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1 1 calc(100% / 3 - 10px);
}

.dv-content .dv-content-box.box1 .form-group label{
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.dv-content .dv-content-box.box1 .form-group select{
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    outline: none;
    background-color: white;
}

.dv-content .dv-content-box.box2 .totalQuizzes{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
}

.dv-content .dv-content-box.box2 .listQuizzes{
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.dv-content .dv-content-box.box2 .listQuizzes>div{
    padding: 10px;
    border-radius: 5px;
    background: url("public/img/default_class.png");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 5px #ccc;
    flex: 1 1 calc(100% / 1 - 15px);
}

@media (min-width: 500px){
.dv-content .dv-content-box.box2 .listQuizzes>div{
    flex: 1 1 calc(100% / 2 - 15px);
    /* max-width: calc(100% / 2 - 15px); */
}
}
@media (min-width: 1200px){
.dv-content .dv-content-box.box2 .listQuizzes>div{
    flex: 1 1 calc(100% / 3 - 15px);
    /* max-width: calc(100% / 3 - 15px); */
}
}

@media (min-width: 1800px){
.dv-content .dv-content-box.box2 .listQuizzes>div{
    flex: 1 1 calc(100% / 4 - 15px);
    /* max-width: calc(100% / 4 - 15px); */
}
}

.dv-content .dv-content-box.box2 .listQuizzes>div>p{
    font-size: 16px;
    color: #333;
    margin: 5px 0;
    font-weight: bold;
}
.dv-content .dv-content-box.box2 .listQuizzes>div>p>span{
    font-weight: normal;
}

.dv-content .dv-content-box.box2 .listQuizzes>div>p>span.null{
    color: red;
}

.dv-content .dv-content-box.box2 .listQuizzes>div>p>a{
    display: inline-block;
    background-color: rgba(25, 25, 255,0.8);
    color: white;
    font-weight: normal;
    padding: 3px 10px;
    border-radius: 5px;
    font-size: 14px;
}
.dv-content .dv-content-box.box2 .listQuizzes>div>p>a:hover{
    background-color: rgba(17, 17, 196, 0.8);
}

.dv-content .dv-content-box.box2 .listQuizzes>div>.srore_v2{
    --mb-percent: 0%;
    position: relative;
    width: 100%;
    background-color: rgb(237, 11, 11,0.8);
    font-size: 9px;
    border-radius: 10px;
    text-align: center;
    color: white;
    /* box-shadow: inset 0 0 15px #ccc; */
    margin-top: 10px;
    overflow: hidden;
    z-index: 1;
    height: 12px;
}

.dv-content .dv-content-box.box2 .listQuizzes>div>.srore_v2::after{
    content: attr(data-percent) '%';
    position: relative;
    z-index: 1;
}

.dv-content .dv-content-box.box2 .listQuizzes>div>.srore_v2>.progress_v2{
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: var(--mb-percent);
    background: green;
    z-index: 0;
}


</style>

<div class="dv-content">

    <h4 class="dv-content-title">Quizzes</h4>
    <div class="dv-content-box box1">
        <div class="form-group">
            <label for="">Class</label>
            <select name="" id="select-class">
                <option value="" disabled selected >No Class</option>
            </select>
        </div>
        <div class="form-group">
            <label for="">Unit</label>
            <select name="" id="select-unit">
                <option value="" disabled selected >No Unit</option>
            </select>
        </div>
        <button class="btn btn-primary" id="btn-filter-quiz">Show Result</button>
    </div>

    <div class="dv-content-box box2">
        <div class="totalQuizzes">
            <span>Total quizzes:</span>
            <span id="mb-totalQuizzes">0</span>
        </div>

        <div class="listQuizzes" id="mb-listQuizzes">

            <!-- <div>
                <p>Class: <span>K198</span></p>
                <p>Unit: <span>Unit 1</span></p>
                <p>Quiz: <a href="#">Quiz 1</a></p>
                <p>Score: <span>9/10</span></p>
                <p><a href="#">History</a></p>
                <div class="srore_v2" style="--mb-percent: 0%" data-percent="0">
                    <div class="progress_v2"></div>
                </div>
            </div> -->

        </div>

    </div>

</div>

<script type="module">
    import { mbNotification, mbConfirm, mbLoading, mbFetch, mbPagination, mbFormData } from './public/js/allmodule.js';

    const divRoot = document.getElementById('root');
    // divRoot.innerHTML = '';

    // variable global

    const dataPage = {
        idClass: null,
        idLesson: null,
    };

    // kiểm tra có param idCourse không thì gắn vào dataPage
    const urlParams = new URLSearchParams(window.location.search);
    let idClass = urlParams.get('class');
    let idLesson = urlParams.get('lesson');

    // kiểm tra nếu param là số thì gắn vào dataPage
    if(!isNaN(idClass)){
        dataPage.idClass = idClass;
    }
    if(!isNaN(idLesson)){
        dataPage.idLesson = idLesson;
    }

    function updateURL(){
        let url = window.location.origin + window.location.pathname;
        if(dataPage.idClass !== null && dataPage.idLesson !== null){
            url += '?class=' + dataPage.idClass + '&lesson=' + dataPage.idLesson;
        }
        window.history.replaceState({}, '', url);
    }


    // lấy danh sách class của 1 người dùng

    (async ()=>{
        const selectClass = document.getElementById('select-class');
        const loading = document.querySelector('.dv-content-box.box1');
        try{
            mbLoading(true, loading);
            const dataClass = await mbFetch('quizzes/getClassByUser');
            emptyElement(selectClass);

            if(dataClass.length === 0){
                const option = document.createElement('option');
                option.value = '';
                option.innerText = 'No Class';
                option.disabled = true;
                option.selected = true;
                selectClass.appendChild(option);
                return;
            }

            dataClass.forEach(item => {
                const option = document.createElement('option');
                option.value = item.idClass;
                option.innerText = item.className;
                if(dataPage.idClass === item.idClass){
                    option.selected = true;
                }
                selectClass.appendChild(option);
            });
            console.log(dataClass);

            if(dataClass.length === 1){
                getUnitByClass(dataClass[0].idClass);
                dataPage.idClass = dataClass[0].idClass;
            }else{
                if(dataPage.idClass !== null){
                    getUnitByClass(dataPage.idClass);
                }else{
                    getUnitByClass(dataClass[0].idClass);
                    dataPage.idClass = dataClass[0].idClass;
                }
            }
            selectClass.addEventListener('change', function(){
                getUnitByClass(this.value);
                dataPage.idClass = this.value;
                dataPage.idLesson = null;
            });

        }catch(e){
            console.log(e);
        }finally{
            mbLoading(false, loading);
        }
    })();

    async function getUnitByClass(idClass){

        const selectUnit = document.getElementById('select-unit');
        const loading = document.querySelector('.dv-content-box.box1');
        try{
            mbLoading(true, loading);
            const dataUnit = await mbFetch('admin/quizzes/getUnitByClass/' + idClass);
            emptyElement(selectUnit);

            if(dataUnit.length === 0){
                const option = document.createElement('option');
                option.value = '';
                option.innerText = 'No Unit';
                option.disabled = true;
                option.selected = true;
                selectUnit.appendChild(option);
            }

            dataUnit.forEach(item => {
                const option = document.createElement('option');
                option.value = item.idLesson;
                option.innerText = item.lessonName;
                if(dataPage.idLesson === item.idLesson){
                    option.selected = true;
                }
                selectUnit.appendChild(option);
            });

            if(dataUnit.length === 1){
                getQuizByUnit(dataPage.idClass,dataUnit[0].idLesson);
                dataPage.idLesson = dataUnit[0].idLesson;
            }else{
                if(dataPage.idLesson !== null){
                    getQuizByUnit(dataPage.idClass,dataPage.idLesson);
                }else{
                    getQuizByUnit(dataPage.idClass,dataUnit[0].idLesson);
                    dataPage.idLesson = dataUnit[0].idLesson;
                }
            }
        }catch(e){
            console.log(e);
        }finally{
            mbLoading(false, loading);
        }
    }

    (()=>{

        const btnFilterQuiz = document.getElementById('btn-filter-quiz');
        btnFilterQuiz.addEventListener('click', function(){
           const idUnit = document.getElementById('select-unit').value;
           const idClass = document.getElementById('select-class').value;
              if(idUnit === '' || idClass === ''){
                mbNotification('error', 'Please select Class and Unit');
                return;
              }
                dataPage.idClass = idClass;
                dataPage.idLesson = idUnit;
                updateURL();
                getQuizByUnit(idClass,idUnit);
        });

    })();

    async function getQuizByUnit(idClass,idUnit){
        const loading = document.querySelector('.dv-content-box.box2');
        try{
            mbLoading(true, loading);
            const dataQuizzes = await mbFetch('admin/quizzes/getQuizByIdLesson/' + idClass + '/' + idUnit);
            console.log(dataQuizzes);
            renderQuizzes(dataQuizzes);
        }catch(e){
            console.log(e);
        }finally{
            mbLoading(false, loading);
        }
    }


    function renderQuizzes(dataQuizzes){

        const EtotalQuiz = document.getElementById('mb-totalQuizzes');
        const ElistQuiz = document.getElementById('mb-listQuizzes');
        EtotalQuiz.innerText = dataQuizzes.length;
        emptyElement(ElistQuiz);
        dataQuizzes.forEach(item => {
            ElistQuiz.appendChild(componentBoxQuiz(item));
        });

    }


    function componentBoxQuiz(row){
        console.log(row)
        let scorePercent = 0;
        if(row.score !== null){
            scorePercent = (row.score / 10) * 100;
        }

        const div = document.createElement('div');
        div.innerHTML = `
        <p>Class: <span>${row.className}</span></p>
        <p>Unit: <span>${row.lessonName}</span></p>
        <p>Quiz: <a href="admin/quizzes/startquiz?class=${row.idClass}&unit=${row.idLesson}&quiz=${row.idQuiz}">${row.quizName}</a></p>
        <p>Score: <span class="${row.score === null ? 'null' : ''}">${row.score === null ? 'null' : row.score + '/10'}</span></p>
        <p><a href="#">History</a></p>
        <div class="srore_v2" style="--mb-percent: ${scorePercent}%" data-percent="${scorePercent}">
        <div class="progress_v2"></div>
        </div>
        `;
        return div;
    }


    function emptyElement(element){
        while(element.firstChild){
            element.removeChild(element.firstChild);
        }
    }

</script>